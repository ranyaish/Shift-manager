<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>מחשבון מיצוע ורווח/הפסד</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- אייקונים + Manifest (PWA) -->
  <link rel="icon" type="image/png" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <link rel="manifest" href="manifest.webmanifest?v=2" />
  <meta name="theme-color" content="#0ea5e9" />

  <style>
    html, body { background:#ffffff; }
    .card { background:#ffffff; }
    .muted { color:#6B7280; }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }
  </style>
</head>
<body class="min-h-screen text-gray-900">
  <div class="max-w-4xl mx-auto p-4 sm:p-8">
    <header class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">מחשבון מיצוע ורווח/הפסד</h1>
      <p class="muted">חישוב ממוצע חדש, רווח/הפסד ($ ו־%), ונקודת איזון. כולל טבלת רגישות.</p>
    </header>

    <div class="grid md:grid-cols-2 gap-6">
      <!-- פוזיציה נוכחית -->
      <section class="card rounded-2xl p-5 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">פוזיציה נוכחית</h2>
        <div class="grid grid-cols-2 gap-4">
          <label class="block">
            <span class="muted text-sm">כמות מניות</span>
            <input id="qty" type="number" inputmode="decimal"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"
              placeholder="למשל 410" />
          </label>
          <label class="block">
            <span class="muted text-sm">שער ממוצע קיים ($)</span>
            <input id="avg" type="number" inputmode="decimal" step="0.0001"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"
              placeholder="למשל 17.79" />
          </label>
          <label class="block col-span-2">
            <span class="muted text-sm">שער נוכחי ($)</span>
            <input id="priceNow" type="number" inputmode="decimal" step="0.0001"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"
              placeholder="למשל 16.16" />
          </label>
          <label class="block col-span-2">
            <span class="muted text-sm">עמלות קיימות (אופציונלי, $)</span>
            <input id="feesExisting" type="number" inputmode="decimal" step="0.01"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-cyan-500"
              placeholder="0" />
          </label>
        </div>
      </section>

      <!-- רכישה למיצוע -->
      <section class="card rounded-2xl p-5 shadow-lg">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold">רכישה למיצוע (אופציונלי)</h2>
          <label class="flex items-center gap-2 text-sm">
            <input id="toggleMode" type="checkbox" class="accent-cyan-500" />
            לפי סכום ($) / לפי כמות
          </label>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <label class="block" id="amountWrap">
            <span class="muted text-sm">סכום הרכישה ($)</span>
            <input id="amount" type="number" inputmode="decimal" step="0.01"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder="1000" />
          </label>
          <label class="block hidden" id="addQtyWrap">
            <span class="muted text-sm">כמות מניות לרכישה</span>
            <input id="addQty" type="number" inputmode="decimal" step="0.0001"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder="לדוגמה 62" />
          </label>
          <label class="block">
            <span class="muted text-sm">שער רכישה ($)</span>
            <input id="buyPrice" type="number" inputmode="decimal" step="0.0001"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder="ברירת מחדל: השער הנוכחי" />
          </label>
          <label class="block">
            <span class="muted text-sm">עמלות קנייה (אופציונלי, $)</span>
            <input id="feesNew" type="number" inputmode="decimal" step="0.01"
              class="w-full mt-1 rounded-xl bg-gray-100 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
              placeholder="0" />
          </label>
        </div>
        <p class="muted text-xs mt-2">טיפ: אם תשאיר את הרכישה ריקה — תראה רק מצב נוכחי ללא מיצוע.</p>
      </section>
    </div>

    <!-- פעולות -->
    <div class="mt-6 flex flex-wrap gap-3">
      <button id="calcBtn" class="bg-cyan-200 hover:bg-cyan-300 px-5 py-2.5 rounded-xl font-semibold shadow text-gray-900">חשב</button>
      <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 px-5 py-2.5 rounded-xl font-semibold text-gray-900">איפוס</button>
      <button id="saveBtn" class="bg-purple-200 hover:bg-purple-300 px-5 py-2.5 rounded-xl font-semibold text-gray-900">שמור קלט</button>
    </div>

    <!-- תוצאות -->
    <section id="results" class="mt-6 grid lg:grid-cols-2 gap-6 hidden">
      <!-- לפני מיצוע -->
      <div class="card rounded-2xl p-5 shadow-lg">
        <h3 class="text-lg font-bold mb-4">לפני מיצוע</h3>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="muted">השקעה כוללת</div><div id="r_inv_before" class="text-right font-mono"></div>
          <div class="muted">שווי נוכחי</div><div id="r_val_before" class="text-right font-mono"></div>
          <div class="muted">רווח/הפסד ($)</div><div id="r_pnl_before" class="text-right font-mono"></div>
          <div class="muted">רווח/הפסד (%)</div><div id="r_pnlp_before" class="text-right font-mono"></div>
          <div class="muted">נק' איזון (שער)</div><div id="r_be_before" class="text-right font-mono"></div>
        </div>
      </div>

      <!-- אחרי מיצוע -->
      <div class="card rounded-2xl p-5 shadow-lg">
        <h3 class="text-lg font-bold mb-4">אחרי מיצוע</h3>
        <div class="grid grid-cols-2 gap-3 text-sm">
          <div class="muted">כמות כוללת</div><div id="r_qty_after" class="text-right font-mono"></div>
          <div class="muted">השקעה כוללת</div><div id="r_inv_after" class="text-right font-mono"></div>
          <div class="muted">ממוצע חדש</div><div id="r_avg_after" class="text-right font-mono"></div>
          <div class="muted">שווי נוכחי</div><div id="r_val_after" class="text-right font-mono"></div>
          <div class="muted">רווח/הפסד ($)</div><div id="r_pnl_after" class="text-right font-mono"></div>
          <div class="muted">רווח/הפסד (%)</div><div id="r_pnlp_after" class="text-right font-mono"></div>
          <div class="muted">נק' איזון (שער)</div><div id="r_be_after" class="text-right font-mono"></div>
        </div>
      </div>
    </section>

    <!-- טבלת רגישות -->
    <section id="sensitivity" class="mt-6 hidden">
      <div class="card rounded-2xl p-5 shadow-lg">
        <h3 class="text-lg font-bold mb-4">רגישות - רווח/הפסד במחירים שונים (אחרי מיצוע)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead class="text-left muted">
              <tr>
                <th class="py-2">מחיר ($)</th>
                <th class="py-2">שווי ($)</th>
                <th class="py-2">רווח/הפסד ($)</th>
                <th class="py-2">רווח/הפסד (%)</th>
              </tr>
            </thead>
            <tbody id="sensBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-xs muted">
      נבנה עבור חישוב מהיר בלבד. אין באמור ייעוץ השקעות.
    </footer>
  </div>

  <!-- רישום Service Worker -->
<script>
  const $ = sel => document.querySelector(sel);
  // פרסר מספרים סלחני: מוריד רווחים/פסיקים/תוים “מוזרים”
  const asNum = v => {
    const s = (v ?? '').toString()
      .replace(/[,\s]/g, '')       // פסיקים ורווחים
      .replace(/[׳’′]/g, '');      // גרשיים “עבריים”
    const n = Number(s);
    return isFinite(n) ? n : 0;
  };
  const fmt2 = n => (Math.round((+n || 0) * 100) / 100).toFixed(2);

  const qty = $('#qty');
  const avg = $('#avg');
  const priceNow = $('#priceNow');
  const feesExisting = $('#feesExisting');

  const toggleMode = $('#toggleMode');
  const amount = $('#amount');
  const addQty = $('#addQty');
  const buyPrice = $('#buyPrice');
  const feesNew = $('#feesNew');
  const amountWrap = $('#amountWrap');
  const addQtyWrap = $('#addQtyWrap');

  const resSec = document.getElementById('results');
  const sensSec = document.getElementById('sensitivity');

  (function loadSaved() {
    try {
      const s = JSON.parse(localStorage.getItem('position_calc_saved') || '{}');
      ['qty','avg','priceNow','feesExisting','amount','addQty','buyPrice','feesNew','toggleMode']
        .forEach(k => {
          if (s[k] !== undefined) {
            if (k === 'toggleMode') toggleMode.checked = !!s[k];
            else document.getElementById(k).value = s[k];
          }
        });
      updateMode();
      if (!buyPrice.value && priceNow.value) buyPrice.value = priceNow.value;
    } catch {}
  })();

  // שמירה / איפוס
  document.getElementById('saveBtn').addEventListener('click', () => {
    const data = {
      qty: qty.value, avg: avg.value, priceNow: priceNow.value, feesExisting: feesExisting.value,
      amount: amount.value, addQty: addQty.value, buyPrice: buyPrice.value, feesNew: feesNew.value,
      toggleMode: toggleMode.checked
    };
    localStorage.setItem('position_calc_saved', JSON.stringify(data));
    alert('הקלט נשמר בדפדפן.');
  });

  document.getElementById('resetBtn').addEventListener('click', () => {
    [qty, avg, priceNow, feesExisting, amount, addQty, buyPrice, feesNew].forEach(el => el.value = '');
    toggleMode.checked = false; updateMode();
    resSec.classList.add('hidden');
    sensSec.classList.add('hidden');
    localStorage.removeItem('position_calc_saved');
  });

  // מצב קלט: סכום/כמות
  document.getElementById('toggleMode').addEventListener('change', () => { updateMode(); calc(); });
  function updateMode(){
    if (toggleMode.checked) { // לפי כמות
      amountWrap.classList.add('hidden');
      addQtyWrap.classList.remove('hidden');
    } else { // לפי סכום
      addQtyWrap.classList.add('hidden');
      amountWrap.classList.remove('hidden');
    }
  }

  // חישוב מרוכז
  function calc() {
    const Q  = asNum(qty.value);
    const A  = asNum(avg.value);
    const P  = asNum(priceNow.value);
    const F0 = asNum(feesExisting.value);

    const useQty = toggleMode.checked;
    const addQ   = useQty ? asNum(addQty.value) : 0;
    if (!buyPrice.value && priceNow.value) buyPrice.value = priceNow.value;
    const PB   = asNum(buyPrice.value || P);
    const Amt  = useQty ? (addQ * PB) : asNum(amount.value);
    const F1   = asNum(feesNew.value);

    if (!Q || !A || !P) return; // דרושים שלושת אלו לפחות

    // לפני מיצוע
    const invested_before = Q * A + F0;
    const value_before    = Q * P;
    const pnl_before      = value_before - invested_before;
    const pnlp_before     = invested_before ? (pnl_before / invested_before * 100) : 0;
    const be_before       = A + (F0 / Math.max(Q, 1e-12));

    // אחרי מיצוע
    const add_qty_calc = useQty ? addQ : (PB ? (Amt / PB) : 0);
    const invested_after = invested_before + Amt + F1;
    const qty_after      = Q + add_qty_calc;
    const avg_after      = qty_after ? (invested_after / qty_after) : 0;
    const value_after    = qty_after * P;
    const pnl_after      = value_after - invested_after;
    const pnlp_after     = invested_after ? (pnl_after / invested_after * 100) : 0;

    // הצגה
    resSec.classList.remove('hidden');
    setText('r_inv_before', '$' + fmt2(invested_before));
    setText('r_val_before', '$' + fmt2(value_before));
    setText('r_pnl_before', formatSigned(pnl_before));
    setText('r_pnlp_before', formatSigned(pnlp_before) + '%');
    setText('r_be_before', '$' + fmt2(be_before));

    setText('r_qty_after', fmt2(qty_after));
    setText('r_inv_after', '$' + fmt2(invested_after));
    setText('r_avg_after', '$' + (qty_after ? fmt2(avg_after) : '0.00'));
    setText('r_val_after', '$' + fmt2(value_after));
    setText('r_pnl_after', formatSigned(pnl_after));
    setText('r_pnlp_after', formatSigned(pnlp_after) + '%');
    setText('r_be_after', '$' + (qty_after ? fmt2(avg_after) : '0.00'));

    // טבלת רגישות
    const sens = [P*0.9, P*0.95, P, P*1.05, P*1.1, avg_after];
    const uniq = Array.from(new Set(sens.map(x => Number(x.toFixed(4))))).sort((a,b)=>a-b);
    const body = document.getElementById('sensBody');
    body.innerHTML = '';
    uniq.forEach(price => {
      const val = qty_after * price;
      const pnl = val - invested_after;
      const pnlp = invested_after ? (pnl / invested_after * 100) : 0;
      body.insertAdjacentHTML('beforeend', `<tr>
        <td class="py-1 font-mono">$${fmt2(price)}</td>
        <td class="py-1 font-mono">$${fmt2(val)}</td>
        <td class="py-1 font-mono ${pnl>=0?'text-green-600':'text-red-600'}">${formatSigned(pnl)}</td>
        <td class="py-1 font-mono ${pnl>=0?'text-green-600':'text-red-600'}">${fmt2(pnlp)}%</td>
      </tr>`);
    });
    sensSec.classList.remove('hidden');
  }

  // עזר
  function setText(id, v){ document.getElementById(id).textContent = v; }
  function formatSigned(n){
    const s = fmt2(n);
    if (n > 0) return '+$' + s;
    if (n < 0) return '-$' + fmt2(Math.abs(n));
    return '$0.00';
  }

  // מחשבים בלחיצה…
  document.getElementById('calcBtn').addEventListener('click', calc);

  // …וגם אוטומטית בכל שינוי קלט (חוויית “חי”)
  [qty, avg, priceNow, feesExisting, amount, addQty, buyPrice, feesNew]
    .forEach(el => el.addEventListener('input', calc));

  // נוחות: עדכן שער רכישה אם לא הוזן
  priceNow.addEventListener('input', () => {
    if (!buyPrice.value) buyPrice.value = priceNow.value;
  });
</script>
</body>
</html>
