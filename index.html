<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>× ×™×”×•×œ ××©××¨×•×ª â€“ × ×•× ×¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="theme-color" content="#111827" />
    <link rel="icon" type="image/png" href="icon-192.png" />
    <link rel="apple-touch-icon" href="icon-192.png" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
      .card { @apply bg-white rounded-2xl shadow p-5 md:p-6; }
      .btn  { @apply px-4 py-2 rounded-xl font-semibold shadow disabled:opacity-50 disabled:cursor-not-allowed transition; }
      .btn-primary { @apply bg-indigo-600 hover:bg-indigo-700 text-white; }
      .btn-ghost   { @apply bg-white hover:bg-gray-50 border border-gray-300; }
      .btn-danger  { @apply bg-rose-600 hover:bg-rose-700 text-white; }
      .tag { @apply inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100; }
      .input, select, textarea { @apply w-full border rounded-xl px-3 py-2 bg-white; }
      .sec-title { @apply text-lg font-bold mb-3; }
      .toolbar { @apply sticky top-0 z-40 bg-gray-100/80 backdrop-blur supports-[backdrop-filter]:bg-gray-100/60 border-b; }
      .kicker { @apply text-xs text-gray-500; }
      .list-row { @apply p-3 bg-white rounded-xl border hover:border-indigo-300 transition; }
      .pill { @apply inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 text-sm font-semibold; }
    </style>

    <!-- ×”×—×œ×£ ×œ×¢×¨×›×™ ×”×¤×¨×•×™×§×˜ ×©×œ×š -->
    <script>
      window.__SUPABASE_URL__ = 'https://uzaqpwbejceyuhnmfdmq.supabase.co';
      window.__SUPABASE_ANON_KEY__ = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6YXFwd2JlamNleXVobm1mZG1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyODc3NzMsImV4cCI6MjA3MDg2Mzc3M30.Wcuu97xzFvJCt8x2ubHLwc19-ZsfrRLK9YZHICV3T3A';
    </script>
  </head>

  <body class="bg-gray-100 min-h-screen">
    <!-- Toolbar -->
    <div class="toolbar">
      <div class="max-w-6xl mx-auto px-4 md:px-8 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-2xl md:text-3xl font-extrabold">ğŸ§© × ×™×”×•×œ ××©××¨×•×ª â€“ × ×•× ×¢</span>
          <span class="hidden md:inline kicker">×’×¨×¡×ª ×¤×™×ª×•×—</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="whoami" class="text-sm text-gray-600 hidden"></span>
          <button id="btnSignOut" class="btn btn-ghost hidden">×”×ª× ×ª×§</button>
        </div>
      </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

      <!-- ×”×ª×—×‘×¨×•×ª -->
      <section id="authSection" class="card">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xl font-extrabold mb-1">×›× ×™×¡×” ×œ××¢×¨×›×ª</div>
            <div class="kicker">×”×–×Ÿ ××™××™×™×œ ×•×¡×™×¡××”</div>
          </div>
        </div>
        <div class="grid md:grid-cols-3 gap-3 mt-4">
          <div>
            <label class="block text-sm mb-1">××™××™×™×œ</label>
            <input id="email" class="input" type="email" placeholder="you@example.com" />
          </div>
          <div>
            <label class="block text-sm mb-1">×¡×™×¡××”</label>
            <input id="password" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
          </div>
          <div class="flex items-end">
            <button id="btnSignIn" type="button" class="btn btn-primary w-full">×›× ×™×¡×”</button>
          </div>
        </div>
      </section>

      <!-- ×¢×•×‘×“ -->
      <section id="employeeSection" class="hidden space-y-4">
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="sec-title m-0">×”×’×©×ª ×–××™× ×•×ª ×œ×©×‘×•×¢</div>
              <div class="kicker">×“×“-×œ×™×™×Ÿ: ×©×™×©×™ 14:00 ×œ×¤× ×™ ×ª×—×™×œ×ª ×”×©×‘×•×¢</div>
            </div>
            <span class="pill">ğŸ“… ×¢×•×‘×“</span>
          </div>
          <div class="grid md:grid-cols-5 gap-3">
            <div class="md:col-span-2">
              <label class="block text-sm mb-1">×©×‘×•×¢ ×©××ª×—×™×œ ×‘×™×•× ×¨××©×•×Ÿ</label>
              <input id="avWeekStart" type="date" class="input" />
            </div>
            <div>
              <label class="block text-sm mb-1">×™×•×</label>
              <select id="avDay" class="input">
                <option value="0">×¨××©×•×Ÿ</option><option value="1">×©× ×™</option><option value="2">×©×œ×™×©×™</option>
                <option value="3">×¨×‘×™×¢×™</option><option value="4">×—××™×©×™</option><option value="5" disabled>×©×™×©×™ (×¡×’×•×¨)</option><option value="6">×©×‘×ª</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">××©×‘×¦×ª</label>
              <select id="avSlot" class="input">
                <option value="lunch">×¦×”×¨×™×™× (11â€“17)</option>
                <option value="dinner">×¢×¨×‘ (17â€“23)</option>
                <option value="long">××¨×•×›×” (12â€“23)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">×”×¢×¨×” (××•×¤×¦×™×•× ×œ×™)</label>
              <input id="avNote" class="input" placeholder="×œ××©×œ: ××¢×“×™×£ 12:30" />
            </div>
          </div>
          <div class="mt-3 flex items-center justify-end gap-2">
            <button id="btnSubmitAvailability" class="btn btn-primary">×©××•×¨ ×–××™× ×•×ª</button>
          </div>
        </div>

        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div class="sec-title m-0">×”××©××¨×•×ª ×©×œ×™</div>
          </div>
          <div id="myShifts" class="space-y-2 text-sm"></div>
        </div>
      </section>

      <!-- ×× ×”×œ -->
      <section id="managerSection" class="hidden space-y-4">

        <!-- ×™×¦×™×¨×ª ×©×‘×•×¢ -->
        <div class="card">
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="sec-title m-0">×™×¦×™×¨×ª ×©×‘×•×¢ ×—×“×©</div>
              <div class="kicker">××™×™×¦×¨ ××ª 6 ×™××™ ×”×¢×‘×•×“×” ×•×”××©×‘×¦×•×ª ×œ×©×‘×•×¢</div>
            </div>
            <span class="pill">ğŸ‘‘ ×× ×”×œ</span>
          </div>
          <div class="grid md:grid-cols-4 gap-3">
            <div class="md:col-span-2">
              <label class="block text-sm mb-1">×©×‘×•×¢ ×©××ª×—×™×œ ×‘×™×•× ×¨××©×•×Ÿ</label>
              <input id="wkWeekStart" type="date" class="input" />
            </div>
            <div class="flex items-end">
              <button id="btnGenerateWeek" class="btn btn-primary w-full">×¦×•×¨ ×©×‘×•×¢</button>
            </div>
          </div>
        </div>

        <!-- ×©×™×‘×•×¥ ××©××¨×•×ª -->
        <div class="card space-y-3">
          <div class="sec-title">×©×™×‘×•×¥ ××©××¨×•×ª</div>
          <div class="grid md:grid-cols-6 gap-3">
            <div class="md:col-span-2">
              <label class="block text-sm mb-1">×ª××¨×™×š (×‘×ª×•×š ×”×©×‘×•×¢)</label>
              <input id="mgrDate" type="date" class="input" />
            </div>
            <div>
              <label class="block text-sm mb-1">××©×‘×¦×ª</label>
              <select id="mgrSlot" class="input">
                <option value="lunch">×¦×”×¨×™×™×</option>
                <option value="dinner">×¢×¨×‘</option>
                <option value="long">××¨×•×›×”</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm mb-1">×¢×•×‘×“</label>
              <select id="mgrEmployee" class="input"></select>
            </div>
            <div>
              <label class="block text-sm mb-1">×¨×›×‘ (×œ×©×œ×™×—×™×)</label>
              <select id="mgrVehicle" class="input">
                <option value="">â€”</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-1">×©×¢×ª ×”×ª×—×œ×”</label>
              <input id="mgrStart" type="time" class="input" value="11:00" />
            </div>
            <div>
              <label class="block text-sm mb-1">×©×¢×ª ×¡×™×•×</label>
              <input id="mgrEnd" type="time" class="input" value="17:00" />
            </div>
            <div class="md:col-span-2 flex items-end">
              <button id="btnAssign" class="btn btn-primary w-full">×©×‘×¥ ×¢×•×‘×“</button>
            </div>
          </div>

          <div>
            <div class="sec-title">×¦×¤×™×™×” ×‘××©××¨×•×ª ×œ×™×•×</div>
            <div id="dayShifts" class="grid md:grid-cols-2 gap-2 text-sm"></div>
          </div>
        </div>

        <!-- × ×™×”×•×œ ×¢×•×‘×“×™× -->
        <div class="card space-y-3">
          <div class="flex items-center justify-between">
            <div class="sec-title m-0">× ×™×”×•×œ ×¢×•×‘×“×™×</div>
            <div class="kicker">×”×•×¡×¤×” ××”×™×¨×”, ×”×©×‘×ª×”, ××™×©×•×¨ ×¨×™×©×™×•×Ÿ</div>
          </div>

          <!-- ×›×¨×˜×™×¡ ×”×•×¡×¤×” ××”×™×¨×” -->
          <div class="list-row">
            <div class="grid md:grid-cols-4 gap-3 items-end">
              <div>
                <label class="block text-sm mb-1">×©× ××œ×</label>
                <input id="empName" class="input" placeholder="×©× ×¤×¨×˜×™ ×•×©× ××©×¤×—×”" />
              </div>
              <div>
                <label class="block text-sm mb-1">×˜×œ×¤×•×Ÿ</label>
                <input id="empPhone" class="input" placeholder="050-0000000" />
              </div>
              <div>
                <label class="block text-sm mb-1">×›×ª×•×‘×ª</label>
                <input id="empAddress" class="input" placeholder="×¨×—×³, ×¢×™×¨" />
              </div>
              <div class="flex items-end">
                <button id="btnAddEmp" class="btn btn-primary w-full">+ ×¢×•×‘×“ ×—×“×©</button>
              </div>
            </div>
          </div>

          <!-- ×¨×©×™××” -->
          <div id="empList" class="grid md:grid-cols-2 gap-2 text-sm"></div>
        </div>
      </section>
    </div>

    <!-- Supabase JS v2 -->
    <script type="module">
      import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

      // ×œ×§×•×— ×™×—×™×“ ×¢× schema=shifts
      const supabase = createClient(
        window.__SUPABASE_URL__,
        window.__SUPABASE_ANON_KEY__,
        { db: { schema: 'shifts' } }
      );
      window.supa = supabase; // ×“×™×‘×•×’

      // DOM
      const authSection = document.getElementById('authSection');
      const employeeSection = document.getElementById('employeeSection');
      const managerSection = document.getElementById('managerSection');
      const whoami = document.getElementById('whoami');
      const btnSignOut = document.getElementById('btnSignOut');

      // Auth
      document.getElementById('btnSignIn').addEventListener('click', async () => {
        const email = (document.getElementById('email').value || '').trim();
        const password = document.getElementById('password').value || '';
        const btn = document.getElementById('btnSignIn');
        btn.disabled = true; btn.textContent = '××ª×—×‘×¨â€¦';
        try {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) return alert('×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ' + error.message);
          await afterAuth();
        } finally {
          btn.disabled = false; btn.textContent = '×›× ×™×¡×”';
        }
      });

      btnSignOut.addEventListener('click', async () => {
        await supabase.auth.signOut();
        location.reload();
      });

      async function afterAuth() {
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error) return alert(error.message);
        if (!user) return;

        whoami.classList.remove('hidden');
        whoami.textContent = user.email || user.id;
        btnSignOut.classList.remove('hidden');
        authSection.classList.add('hidden');

        const { data: prof, error: perr } = await supabase
          .from('user_profiles')
          .select('app_role, employee_id')
          .eq('user_id', user.id)
          .maybeSingle();
        if (perr) return alert('×©×’×™××ª ×¤×¨×•×¤×™×œ: ' + perr.message);

        if (prof?.app_role === 'manager') initManager();
        else initEmployee(prof?.employee_id);
      }

      // ===== Employee =====
      async function initEmployee(employeeId) {
        employeeSection.classList.remove('hidden');
        document.getElementById('avWeekStart').value = isoOfUpcomingSunday();

        document.getElementById('btnSubmitAvailability').addEventListener('click', async () => {
          const week_start = document.getElementById('avWeekStart').value;
          const day_of_week = +document.getElementById('avDay').value;
          const slot = document.getElementById('avSlot').value;
          const note = document.getElementById('avNote').value || null;

          if (!withinDeadline(week_start)) {
            return alert('×¢×‘×¨ ×”×“×“-×œ×™×™×Ÿ ×œ×”×’×©×ª ×–××™× ×•×ª ×œ×©×‘×•×¢ ×–×” (×©×™×©×™ 14:00).');
          }

          const { error } = await supabase.from('availability').insert({
            employee_id: employeeId, week_start, day_of_week, slot, note
          });
          if (error) return alert('×©×’×™××” ×‘×©××™×¨×ª ×–××™× ×•×ª: ' + error.message);
          alert('×”×–××™× ×•×ª × ×©××¨×” âœ…');
        });

        await refreshMyShifts();
      }

      async function refreshMyShifts() {
        const box = document.getElementById('myShifts');
        box.innerHTML = '';
        const { data: rows, error } = await supabase
          .from('shift_assignments')
          .select('id, start_time, end_time, status, shift:shift_id(date, slot), vehicle:vehicle_id(code)')
          .order('start_time');
        if (error) return box.innerHTML = `<div class="text-red-600">${error.message}</div>`;
        if (!rows?.length) return box.innerHTML = '<div class="text-gray-500">××™×Ÿ ×©×™×‘×•×¦×™× ×œ×”×¦×’×”.</div>';
        rows.forEach(r => {
          const d = new Date(r.shift.date);
          const day = d.toLocaleDateString('he-IL', { weekday:'long', year:'numeric', month:'2-digit', day:'2-digit' });
          const slotTxt = slotName(r.shift.slot);
          const veh = r.vehicle?.code ? ` Â· ×¨×›×‘ ${r.vehicle.code}` : '';
          const el = document.createElement('div');
          el.className = 'list-row flex items-center justify-between';
          el.innerHTML = `<div>
              <div class="font-semibold">${day} Â· ${slotTxt}${veh}</div>
              <div class="text-gray-600">×©×¢×•×ª: ${r.start_time?.slice(0,5)}â€“${r.end_time?.slice(0,5)}</div>
            </div>
            <span class="tag">${statusName(r.status)}</span>`;
          box.appendChild(el);
        });
      }

      // ===== Manager =====
      async function initManager() {
        managerSection.classList.remove('hidden');
        document.getElementById('wkWeekStart').value = isoOfUpcomingSunday();
        document.getElementById('mgrDate').value = isoToday();
        await loadActiveEmployees();
        await loadVehicles();

        document.getElementById('btnGenerateWeek').addEventListener('click', async () => {
          const week = document.getElementById('wkWeekStart').value;
          const { error } = await supabase.rpc('generate_weekly_roster', { p_week_start: week });
          if (error) return alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×©×‘×•×¢: ' + error.message);
          alert('× ×•×¦×¨ ×©×‘×•×¢ ×‘×”×¦×œ×—×” âœ…');
        });

        document.getElementById('btnAssign').addEventListener('click', async () => {
          const date = document.getElementById('mgrDate').value;
          const slot = document.getElementById('mgrSlot').value;
          const employee_id = document.getElementById('mgrEmployee').value;
          const start_time = document.getElementById('mgrStart').value;
          const end_time = document.getElementById('mgrEnd').value;
          const vehicle_id = document.getElementById('mgrVehicle').value || null;

          // ××¦× shift ×œ××•×ª×• ×™×•×/×¡×œ×•×˜
          const { data: shiftRow, error: sErr } = await supabase
            .from('shifts')
            .select('id')
            .eq('date', date).eq('slot', slot)
            .maybeSingle();
          if (sErr) return alert('×©×’×™××” ×‘×—×™×¤×•×© ××©××¨×ª: ' + sErr.message);
          if (!shiftRow) return alert('×œ× × ××¦××” ××©××¨×ª ×œ×™×•×/×¡×œ×•×˜ ×”×–×”. ×¦×•×¨ ×©×‘×•×¢ ×ª×—×™×œ×”.');

          // ××™×Ÿ ×§×˜×’×•×¨×™×•×ª ×ª×¤×§×™×“×™× -> role default
          const { error } = await supabase.from('shift_assignments').insert({
            shift_id: shiftRow.id,
            employee_id,
            start_time,
            end_time,
            vehicle_id: vehicle_id || null,
            status: 'planned',
            role: 'other'
          });
          if (error) return alert('×©×’×™××” ×‘×©×™×‘×•×¥: ' + error.message);
          alert('×©×•×‘×¥ ×‘×”×¦×œ×—×” âœ…');
          renderDayShifts();
        });

        document.getElementById('mgrDate').addEventListener('change', renderDayShifts);
        document.getElementById('mgrSlot').addEventListener('change', renderDayShifts);
        await renderDayShifts();

        // ×”×•×¡×¤×ª ×¢×•×‘×“
        document.getElementById('btnAddEmp').addEventListener('click', async () => {
          const full_name = document.getElementById('empName').value.trim();
          if (!full_name) return alert('×—×¡×¨ ×©×');
          const phone = document.getElementById('empPhone').value.trim() || null;
          const address = document.getElementById('empAddress').value.trim() || null;
          const { error } = await supabase.from('employees').insert({ full_name, phone, address });
          if (error) return alert('×©×’×™××” ×‘×”×•×¡×¤×ª ×¢×•×‘×“: ' + error.message);
          document.getElementById('empName').value='';
          document.getElementById('empPhone').value='';
          document.getElementById('empAddress').value='';
          await loadActiveEmployees();
          await listEmployees();
        });

        await listEmployees();
      }

      async function loadActiveEmployees() {
        const sel = document.getElementById('mgrEmployee');
        sel.innerHTML = '';
        const { data, error } = await supabase.from('employees').select('id, full_name').eq('active', true).order('full_name');
        if (error) { sel.innerHTML = '<option>×©×’×™××”</option>'; return; }
        data.forEach(e => {
          const o = document.createElement('option');
          o.value = e.id; o.textContent = e.full_name; sel.appendChild(o);
        });
      }

      async function loadVehicles() {
        const sel = document.getElementById('mgrVehicle');
        const { data, error } = await supabase.from('vehicles').select('id, code').eq('active', true).order('code');
        if (error) return;
        data.forEach(v => { const o = document.createElement('option'); o.value=v.id; o.textContent=v.code; sel.appendChild(o); });
      }

      async function renderDayShifts() {
        const date = document.getElementById('mgrDate').value;
        const slot = document.getElementById('mgrSlot').value;
        const box = document.getElementById('dayShifts');
        box.innerHTML = '';

        const { data: s, error: e1 } = await supabase
          .from('shifts')
          .select('id, planned_start, planned_end')
          .eq('date', date).eq('slot', slot)
          .maybeSingle();
        if (e1) return box.innerHTML = `<div class='text-red-600'>${e1.message}</div>`;
        if (!s) return box.innerHTML = `<div class='text-gray-500'>××™×Ÿ ××©××¨×ª ×‘×™×•× ×–×”. ×¦×•×¨ ×©×‘×•×¢ ×ª×—×™×œ×”.</div>`;

        const { data: rows, error } = await supabase
          .from('shift_assignments')
          .select('id, employee:employee_id(full_name, phone), start_time, end_time, vehicle:vehicle_id(code), status')
          .eq('shift_id', s.id)
          .order('start_time');
        if (error) return box.innerHTML = `<div class='text-red-600'>${error.message}</div>`;
        if (!rows?.length) return box.innerHTML = `<div class='text-gray-500'>××™×Ÿ ×©×™×‘×•×¦×™× ×œ××©××¨×ª ×–×•.</div>`;

        rows.forEach(r => {
          const el = document.createElement('div');
          el.className = 'list-row flex items-center justify-between';
          el.innerHTML = `<div>
              <div class="font-semibold">${r.employee?.full_name || 'â€”'} ${r.vehicle?.code?('Â· ×¨×›×‘ '+r.vehicle.code):''}</div>
              <div class="text-gray-600">×©×¢×•×ª: ${r.start_time?.slice(0,5)}â€“${r.end_time?.slice(0,5)} Â· ×˜×œ×³ ${r.employee?.phone || ''}</div>
            </div>
            <span class="tag">${statusName(r.status)}</span>`;
          box.appendChild(el);
        });
      }

      async function listEmployees() {
        const box = document.getElementById('empList');
        const { data, error } = await supabase
          .from('employees')
          .select('id, full_name, phone, address, active, driver_license_verified')
          .order('active', { ascending: false })
          .order('full_name');
        if (error) return box.innerHTML = `<div class='text-red-600'>${error.message}</div>`;
        if (!data?.length) return box.innerHTML = '<div class="text-gray-500">××™×Ÿ ×¢×•×‘×“×™×</div>';
        box.innerHTML = '';
        data.forEach(e => {
          const row = document.createElement('div');
          row.className = 'list-row flex items-center justify-between gap-3';
          row.innerHTML = `
            <div>
              <div class="font-semibold ${e.active? '':'line-through text-gray-400'}">${e.full_name}</div>
              <div class="text-gray-600 text-xs">${e.phone || ''} Â· ${e.address || ''}</div>
              <div class="mt-1 flex gap-2">
                <span class="tag">${e.active? '×¤×¢×™×œ':'××•×©×‘×ª'}</span>
                <span class="tag">×¨×™×©×™×•×Ÿ: ${e.driver_license_verified? '×××•×©×¨ âœ…':'×œ× ×××•×©×¨'}</span>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <button class="btn btn-ghost text-sm" data-action="toggle-license" data-id="${e.id}">${e.driver_license_verified? '×‘×˜×œ ××™×©×•×¨':'××©×¨ ×¨×™×©×™×•×Ÿ'}</button>
              <button class="btn ${e.active?'btn-danger':'btn-primary'} text-sm" data-action="${e.active?'deactivate':'activate'}" data-id="${e.id}">${e.active?'×”×¡×¨ ×¢×•×‘×“':'×”×¤×¢×œ ×¢×•×‘×“'}</button>
            </div>`;
          box.appendChild(row);
        });
        box.querySelectorAll('button').forEach(btn => btn.addEventListener('click', onEmpAction));
      }

      async function onEmpAction(ev) {
        const id = ev.currentTarget.getAttribute('data-id');
        const action = ev.currentTarget.getAttribute('data-action');

        if (action === 'deactivate' || action === 'activate') {
          if (action === 'deactivate' && !confirm('×œ×”×¡×™×¨ ××ª ×”×¢×•×‘×“ (Soft delete)?')) return;
          const newVal = action === 'activate';
          const { error } = await supabase.from('employees').update({ active: newVal }).eq('id', id);
          if (error) return alert('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¢×•×‘×“: ' + error.message);
          await loadActiveEmployees();
          await listEmployees();
        }

        if (action === 'toggle-license') {
          const { data, error } = await supabase.from('employees').select('driver_license_verified').eq('id', id).maybeSingle();
          if (error) return alert(error.message);
          const { error: uerr } = await supabase
            .from('employees')
            .update({ driver_license_verified: !data.driver_license_verified })
            .eq('id', id);
          if (uerr) return alert('×©×’×™××ª ××™×©×•×¨/×‘×™×˜×•×œ ×¨×™×©×™×•×Ÿ: ' + uerr.message);
          await listEmployees();
        }
      }

      // Utils
      function slotName(s){ return s==='lunch'?'×¦×”×¨×™×™×':(s==='dinner'?'×¢×¨×‘':'××¨×•×›×”'); }
      function statusName(s){ return {planned:'××ª×•×›× ×Ÿ',confirmed:'×××•×©×¨',canceled:'××‘×•×˜×œ'}[s]||s; }
      function isoToday(){ const d=new Date(); const z=d.getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
      function isoOfUpcomingSunday(){ const d=new Date(); const day=(d.getDay()+6)%7; const diff=-day; const sunday=new Date(d.getFullYear(),d.getMonth(),d.getDate()+diff); const z=sunday.getTimezoneOffset()*60000; return new Date(sunday - z).toISOString().slice(0,10); }
      function withinDeadline(weekStartISO){
        const ws = new Date(weekStartISO+'T00:00:00');
        const deadline = new Date(ws); deadline.setDate(deadline.getDate()-2); deadline.setHours(14,0,0,0);
        return new Date() <= deadline;
      }

      // Auto init
      (async () => {
        const { data:{ user } } = await supabase.auth.getUser();
        if (user) afterAuth();
      })();
    </script>
  </body>
</html>
